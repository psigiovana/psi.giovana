<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Contrato Psicóloga Giovana CRP:08/45995</title>
<style>
body { font-family: Arial, sans-serif; background: #ffd9df; padding: 20px; text-align: center; }
.container { background: #fff; padding: 20px; max-width: 600px; margin: auto; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
input, button { padding: 10px; margin: 10px 0; width: 90%; border: 1px solid #ccc; border-radius: 5px; }
button { background: #ffaddd; color: black; font-size: 15px; border: none; cursor: pointer; transition: 0.3s; }
button:hover { background: #ffd9df; }
button:disabled { background: #ccc; cursor: not-allowed; }
.spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid white; border-top: 2px solid #ffaddd; border-radius: 50%; animation: spin 0.8s linear infinite; vertical-align: middle; margin-right: 8px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
iframe { width: 100%; height: 500px; border: 1px solid #ddd; margin-top: 15px; }
</style>

<script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
</head>
<body>

<img src="banner_assinatura.png" alt="Banner de Assinatura" style="width:80%; height:250px;">
<div class="container">
<h2>Assinatura do Contrato de Psicoterapia</h2>

<form id="formContrato">
  <input type="text" id="nome" placeholder="Nome completo" required>
  <input type="text" id="nomeSocial" placeholder="Nome social (opcional)">
  <input type="text" id="cpf" placeholder="CPF" required>
  <input type="text" id="rg" placeholder="RG" required>
  <input type="text" id="telefone" placeholder="Telefone / WhatsApp" required>
  <button type="submit" id="btnEnviar">Assinar e Enviar</button>
</form>

<iframe id="pdfViewer" src="Contrato.pdf"></iframe>
<button id="shareBtn" style="margin-top:10px;">Compartilhar PDF pelo WhatsApp</button>
</div>

<script>
let pdfBlobGlobal = null; // guarda o PDF gerado
let dadosGlobais = null; // guarda os dados preenchidos

const form = document.getElementById("formContrato");
const btn = document.getElementById("btnEnviar");
const pdfViewer = document.getElementById("pdfViewer");
const contato = "5544997112467"; // número do WhatsApp com DDI
const shareBtn = document.getElementById("shareBtn");


form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>Enviando...';

  const dados = {
    nome: document.getElementById("nome").value.trim(),
    nomeSocial: document.getElementById("nomeSocial").value.trim(),
    cpf: document.getElementById("cpf").value.trim(),
    rg: document.getElementById("rg").value.trim(),
    telefone: document.getElementById("telefone").value.trim()
  };

  dadosGlobais = dados; // salva para compartilhar depois

  try {
    const res = await fetch("Contrato.pdf");
    if (!res.ok) throw new Error("Contrato.pdf não encontrado");
    const existingPdfBytes = await res.arrayBuffer();

    const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
    const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);

    const pages = pdfDoc.getPages();
    const firstPage = pages[0];
    const { height } = firstPage.getSize();

    firstPage.drawText(dados.nome, { x:130, y:height-248, size:12, font });
    if(dados.nomeSocial) firstPage.drawText(dados.nomeSocial, { x:180, y:height-268, size:12, font });
    firstPage.drawText(dados.cpf, { x:360, y:height-270, size:12, font });
    firstPage.drawText(dados.rg, { x:120, y:height-293, size:12, font });
    firstPage.drawText(dados.telefone, { x:380, y:height-293, size:12, font });
    firstPage.drawText(`Assinado digitalmente por: ${dados.nome}`, { x:50, y:100, size:12, font });
    firstPage.drawText(`Data: ${new Date().toLocaleDateString("pt-BR")}`, { x:50, y:85, size:12, font });

    if(pages.length > 1){
      const secondPage = pages[1];
      const { height: h2 } = secondPage.getSize();
      secondPage.drawText(dados.nome, { x:250, y:h2-320, size:12, font });
      secondPage.drawText(new Date().toLocaleDateString("pt-BR"), { x:230, y:h2-300, size:12, font });
      secondPage.drawText(`Assinado digitalmente por: ${dados.nome}`, { x:50, y:100, size:12, font });
      secondPage.drawText(`Data: ${new Date().toLocaleDateString("pt-BR")}`, { x:50, y:85, size:12, font });
    }

    const pdfBytes = await pdfDoc.save();
    pdfBlobGlobal = new Blob([pdfBytes], { type:"application/pdf" });
    const localUrl = URL.createObjectURL(pdfBlobGlobal);
    pdfViewer.src = localUrl;

    // Download automático
    const a = document.createElement("a");
    a.href = localUrl;
    a.download = `${dados.nome.replace(/\s+/g,' ')}_Contrato.pdf`;
    document.body.appendChild(a);
    a.click();
    a.remove();

    // WhatsApp com mensagem inicial e link para o PDF gerado
    const urlPdf = localUrl;
    const msgLink = encodeURIComponent(`Olá Giovana, segue o contrato assinado por ${dados.nome}`);
    window.open(`https://wa.me/${contato}?text=${msgLink}`, "_blank");

  } catch (err) {
    console.error("❌ Erro:", err);
    alert("Erro: " + err.message);
  } finally {
    btn.disabled = false;
    btn.textContent = originalText;
  }
});

// Compartilhar PDF via Web Share API
shareBtn.addEventListener("click", async () => {
  if(!pdfBlobGlobal){
    alert("Primeiro assine o contrato para gerar o PDF.");
    return;
  }
  const file = new File([pdfBlobGlobal], `${dadosGlobais.nome}_Contrato_Assinado.pdf`, { type: "application/pdf" });

  if(!navigator.canShare || !navigator.canShare({ files: [file] })){
    alert("Compartilhamento de arquivos não suportado neste navegador.");
    return;
  }

  try{
    await navigator.share({
      files: [file],
      title: "Contrato Assinado",
      text: "Segue o contrato assinado."
    });
    console.log("Share dialog aberto");
  } catch(err){
    console.error("Compartilhamento cancelado ou erro:", err);
  }
});
</script>
</body>
</html>

