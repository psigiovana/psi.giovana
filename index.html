<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Contrato Psicóloga Giovana CRP:08/45995</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f3e8db; padding: 20px; color: #333; }
        .container { background: #fff; padding: 30px; max-width: 700px; margin: auto; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header-img { max-width: 200px; margin-bottom: 20px; }
        h2 { color: #8d6e63; margin-bottom: 25px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .full-width { grid-column: span 2; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; transition: border 0.3s; }
        input:focus { border-color: #8d6e63; }
        button { background: #8d6e63; color: white; padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; width: 100%; margin-top: 20px; }
        button:hover { background: #6d4c41; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        iframe { width: 100%; height: 600px; border: 1px solid #eee; border-radius: 8px; margin-top: 20px; background: #fafafa; }
        .spinner { display: inline-block; width: 18px; height: 18px; border: 3px solid rgba(255,255,255,.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s ease-in-out infinite; margin-right: 10px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .label-preview { font-size: 13px; font-weight: bold; color: #8d6e63; margin-top: 20px; display: block; text-align: left; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
</head>
<body>

    <div class="container">
        <img src="banner_assinatura.png" alt="Logo" class="header-img">
        <h2>Contrato de Psicoterapia</h2>
        
        <form id="formContrato">
            <div class="form-grid">
                <input type="text" id="nome" class="full-width" placeholder="Nome Completo" required>
                <input type="text" id="nomeSocial" placeholder="Nome Social (opcional)">
                <input type="text" id="cpf" placeholder="CPF" required>
                <input type="text" id="rg" placeholder="RG" required>
                <input type="text" id="telefone" placeholder="WhatsApp" required>
            </div>

            <label class="label-preview">PRÉ-VISUALIZAÇÃO DO CONTRATO:</label>
            <iframe id="pdfViewer"></iframe>

            <button type="submit" id="btnEnviar">ASSINAR E ENVIAR AGORA</button>
        </form>
    </div>

<script>
    const pdfViewer = document.getElementById("pdfViewer");
    const form = document.getElementById("formContrato");
    const btn = document.getElementById("btnEnviar");
    const contato = "5544997112467";

    function wrapText(text, maxWidth, font, fontSize) {
        const words = text.split(' ');
        const lines = [];
        let currentLine = words[0];

        for (let i = 1; i < words.length; i++) {
            const word = words[i];
            const width = font.widthOfTextAtSize(currentLine + ' ' + word, fontSize);
            if (width < maxWidth) {
                currentLine += ' ' + word;
            } else {
                lines.push(currentLine);
                currentLine = word;
            }
        }
        lines.push(currentLine);
        return lines;
    }

    async function gerarPDF() {
        const dados = {
            nome: document.getElementById("nome").value.trim() || "________________________________",
            social: document.getElementById("nomeSocial").value.trim() || "________________________",
            cpf: document.getElementById("cpf").value.trim() || "___________",
            rg: document.getElementById("rg").value.trim() || "___________",
            tel: document.getElementById("telefone").value.trim() || "___________",
            data: new Date().toLocaleDateString("pt-BR")
        };

        const pdfDoc = await PDFLib.PDFDocument.create();
        const fontReg = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
        const fontBold = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);

        const page = pdfDoc.addPage([595.28, 841.89]); // Tamanho A4 padrão
        let y = 800;
        const margin = 50;
        const width = 495;

        // Cabeçalho unificado
        page.drawText('', { x: margin, y, size: 9, font: fontReg });
        y -= 25;
        page.drawText('CONTRATO DE PSICOTERAPIA', { x: 170, y, size: 14, font: fontBold });
        y -= 30;

        // Introdução
        const intro = "Eu, Giovana de Morais, Psicóloga (CRP 08/45995), e você, paciente abaixo identificado(a), firmamos este acordo com o objetivo de estabelecer clareza e segurança em nosso processo terapêutico.";
        wrapText(intro, width, fontReg, 10).forEach(line => {
            page.drawText(line, { x: margin, y, size: 10, font: fontReg });
            y -= 14;
        });

        y -= 15;
        // Dados do Paciente
        page.drawText('Dados do(a) Paciente:', { x: margin, y, size: 10, font: fontBold });
        y -= 18;
        page.drawText(`Nome: ${dados.nome}`, { x: margin, y, size: 10, font: fontReg });
        y -= 14;
        page.drawText(`Nome social: ${dados.social}   CPF: ${dados.cpf}`, { x: margin, y, size: 10, font: fontReg });
        y -= 14;
        page.drawText(`RG: ${dados.rg}   Telefone/WhatsApp: ${dados.tel}`, { x: margin, y, size: 10, font: fontReg });
        y -= 25;

        // Cláusulas (Todas juntas na mesma página)
        const secoes = [
            { t: "1. Sobre o atendimento:", c: "Nossas sessões de psicoterapia terão duração de aproximadamente 50 minutos e acontecerão semanalmente ou quinzenalmente em formato presencial em Maringá-PR ou on-line, conforme combinado." },
            { t: "2. Valores e forma de pagamento:", c: "Cada sessão tem o valor de R$ 80,00 (social para estudantes e baixa renda) e R$100,00 valor convencional. O pagamento poderá ser realizado por: (PIX, Transferência ou Dinheiro). Sendo realizado até o dia 10 de cada mês, ou no dia das sessões." },
            { t: "3. Cancelamentos e/ faltas:", c: "Para que nosso processo tenha continuidade e respeito ao tempo de ambos: Se precisar cancelar, avise com no mínimo 24 horas de antecedência. Cancelamentos fora desse prazo ou faltas sem aviso terão a cobrança integral da sessão." },
            { t: "4. Sigilo e ética:", c: "Tudo o que você compartilhar nas sessões será mantido em sigilo absoluto, conforme previsto no Código de Ética Profissional do Psicólogo. Somente em situações previstas por lei (ex.: risco à sua vida ou à de terceiros) o sigilo poderá ser quebrado. Em relação a psicoterapia realizada online, é necessário que o ambiente seja tranquilo, silencioso e reservado. Use fones de ouvido para mais privacidade e concentração." },
            { t: "5. Encerramento do processo:", c: "A psicoterapia é um processo construído em conjunto. Tanto você quanto eu podemos decidir pelo encerramento, sempre conversando abertamente sobre o momento mais adequado." },
            { t: "6. Compromisso Mútuo:", c: "Este contrato não é apenas um documento, mas um acordo de confiança e respeito mútuo. Estamos aqui para construir um espaço seguro, acolhedor e transformador." }
        ];

        secoes.forEach(s => {
            page.drawText(s.t, { x: margin, y, size: 10, font: fontBold });
            y -= 14;
            wrapText(s.c, width, fontReg, 9).forEach(line => {
                page.drawText(line, { x: margin, y, size: 9, font: fontReg });
                y -= 12; // Espaçamento menor entre as linhas do parágrafo
            });
            y -= 12; // Espaçamento entre uma cláusula e outra
        });

        y -= 15;
        // Rodapé com Local e Data
        page.drawText(`Local e data: Maringá, ${dados.data}`, { x: margin, y, size: 10, font: fontReg });
        y -= 45;

        // Linhas de Assinatura
        page.drawLine({ start: { x: margin, y }, end: { x: 250, y }, thickness: 1 });
        page.drawLine({ start: { x: 320, y }, end: { x: 520, y }, thickness: 1 });
        y -= 15;
        page.drawText('Assinatura do(a) Paciente', { x: margin + 20, y, size: 9, font: fontReg });
        page.drawText('Giovana de Morais - CRP-08/45995', { x: 330, y, size: 9, font: fontReg });
        y -= 15;
        // Repete o nome do paciente abaixo da linha de assinatura para confirmação digital
        //page.drawText(dados.nome, { x: margin, y, size: 8, font: fontBold });

        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        pdfViewer.src = URL.createObjectURL(blob);
        return blob;
    }

    form.addEventListener('input', () => {
        gerarPDF();
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>Processando...';
        
        try {
            const blob = await gerarPDF();
            const nome = document.getElementById("nome").value;
            const nomeArquivo = `Contrato_${nome.replace(/\s+/g, '_')}.pdf`;
            
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = async () => {
                const base64 = reader.result.split(',')[1];
                await fetch("https://contratos-assinados.onrender.com/upload", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ nomeArquivo, conteudoBase64: base64 })
                });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = nomeArquivo;
                link.click();

                window.open(`https://wa.me/${contato}?text=Olá Giovana, contrato assinado por ${nome}`, "_blank");
                alert("Sucesso! Contrato enviado.");
            };
        } catch (e) {
            alert("Erro ao processar.");
        } finally {
            btn.disabled = false;
            btn.innerText = "ASSINAR E ENVIAR AGORA";
        }
    });

    // Iniciar com preview vazio
    window.onload = gerarPDF;
</script>
</body>
</html>
