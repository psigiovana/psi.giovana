<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Contrato Psicóloga Giovana CRP:08/45995</title>
<style>
body { font-family: Arial, sans-serif; background: #ffd9df; padding: 20px; text-align: center; }
.container { background: #fff; padding: 20px; max-width: 600px; margin: auto; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
input, button { padding: 10px; margin: 10px 0; width: 90%; border: 1px solid #ccc; border-radius: 5px; }
button { background: #ffaddd; color: black; font-size: 15px; border: none; cursor: pointer; }
button:hover { background: #ffd9df; }
iframe { width: 100%; height: 500px; border: 1px solid #ddd; margin-top: 15px; }
</style>
</head>
<body>

<img src="banner_assinatura.png" alt="Banner de Assinatura" style="width:80%; height:250px;">
<div class="container">
<h2>Assinatura do Contrato de Psicoterapia</h2>

<form id="formContrato">
  <input type="text" id="nome" placeholder="Nome completo" required>
  <input type="text" id="nomeSocial" placeholder="Nome social (opcional)">
  <input type="text" id="cpf" placeholder="CPF" required>
  <input type="text" id="rg" placeholder="RG" required>
  <input type="text" id="telefone" placeholder="Telefone / WhatsApp" required>
  <button type="submit">Assinar e Enviar</button>
</form>

<iframe id="pdfViewer" src="Contrato.pdf"></iframe>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>

<script>
document.getElementById("formContrato").addEventListener("submit", async (e) => {
    e.preventDefault();

    const dados = {
        nome: document.getElementById("nome").value,
        nomeSocial: document.getElementById("nomeSocial").value,
        cpf: document.getElementById("cpf").value,
        rg: document.getElementById("rg").value,
        telefone: document.getElementById("telefone").value
    };

    try {
        // Carrega PDF original
        const existingPdfBytes = await fetch("Contrato.pdf").then(res => res.arrayBuffer());
        const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
        const pages = pdfDoc.getPages();
        const firstPage = pages[0];
        const secondPage = pages[1];
        const { height: height1 } = firstPage.getSize();
        const { height: height2 } = secondPage.getSize();

        // Preenche PDF
        firstPage.drawText(dados.nome, { x: 130, y: height1 - 248, size: 12 });
        if(dados.nomeSocial) firstPage.drawText(dados.nomeSocial, { x: 180, y: height1 - 268, size: 12 });
        firstPage.drawText(dados.cpf, { x: 360, y: height1 - 270, size: 12 });
        firstPage.drawText(dados.rg, { x: 120, y: height1 - 293, size: 12 });
        firstPage.drawText(dados.telefone, { x: 380, y: height1 - 293, size: 12 });
        firstPage.drawText(`Assinado digitalmente por: ${dados.nome}`, { x: 50, y: 100, size: 12 });
        firstPage.drawText(`Data: ${new Date().toLocaleDateString("pt-BR")}`, { x: 50, y: 85, size: 12 });

        if(secondPage){
            secondPage.drawText(dados.nome,{ x: 250, y: height2 - 320, size: 12 });
            secondPage.drawText(`${new Date().toLocaleDateString("pt-BR")}`, { x: 230, y: 545, size: 12 });
            secondPage.drawText(`Assinado digitalmente por: ${dados.nome}`, { x: 50, y: 100, size: 12 });
            secondPage.drawText(`Data: ${new Date().toLocaleDateString("pt-BR")}`, { x: 50, y: 85, size: 12 });
        }

        // Salva PDF em Blob e exibe
        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: "application/pdf" });
        const url = URL.createObjectURL(blob);
        document.getElementById("pdfViewer").src = url;

        // Baixar PDF localmente
        const link = document.createElement("a");
        link.href = url;
        link.download = `${dados.nome}_Contrato_Preenchido.pdf`;
        link.click();

        // Abrir WhatsApp com mensagem pronta
        const mensagem = encodeURIComponent(`Olá Giovana, o contrato foi assinado por ${dados.nome}.`);
        const whatsappURL = `https://wa.me/5544997112467?text=${mensagem}`;
        window.open(whatsappURL, "_blank");

    } catch(err){
        console.error(err);
        alert("Erro ao gerar PDF. Veja console.");
    }
});
</script>

</body>
</html>
