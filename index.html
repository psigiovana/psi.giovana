<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Contrato Psicóloga Giovana CRP:08/45995</title>
<style>
body { font-family: Arial, sans-serif; background: #ffd9df; padding: 20px; text-align: center; }
.container { background: #fff; padding: 20px; max-width: 600px; margin: auto; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
input, button { padding: 10px; margin: 10px 0; width: 90%; border: 1px solid #ccc; border-radius: 5px; }
button { background: #ffaddd; color: black; font-size: 15px; border: none; cursor: pointer; transition: 0.3s; }
button:hover { background: #ffd9df; }
button:disabled { background: #ccc; cursor: not-allowed; }
.spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid white; border-top: 2px solid #ffaddd; border-radius: 50%; animation: spin 0.8s linear infinite; vertical-align: middle; margin-right: 8px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
iframe { width: 100%; height: 500px; border: 1px solid #ddd; margin-top: 15px; }
</style>

<script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
</head>
<body>

<img src="banner_assinatura.png" alt="Banner de Assinatura" style="width:80%; height:250px;">
<div class="container">
<h2>Assinatura do Contrato de Psicoterapia</h2>

<form id="formContrato">
  <input type="text" id="nome" placeholder="Nome completo" required>
  <input type="text" id="nomeSocial" placeholder="Nome social (opcional)">
  <input type="text" id="cpf" placeholder="CPF" required>
  <input type="text" id="rg" placeholder="RG" required>
  <input type="text" id="telefone" placeholder="Telefone / WhatsApp" required>
  <button type="submit" id="btnEnviar">Assinar e Enviar</button>
</form>

<iframe id="pdfViewer" src="Contrato.pdf"></iframe>
</div>

<script>
let pdfBlobGlobal = null;
let dadosGlobais = null;

const form = document.getElementById("formContrato");
const btn = document.getElementById("btnEnviar");
const pdfViewer = document.getElementById("pdfViewer");
const contato = "5544997112467"; // WhatsApp destino

// === Gerar hash de 4 dígitos ===
function gerarHash4() {
  return Math.floor(1000 + Math.random() * 9000); // Ex: 4827
}

// === Submissão do formulário ===
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.innerHTML = '<span class="spinner"></span>Gerando...';

  const dados = {
    nome: document.getElementById("nome").value.trim(),
    nomeSocial: document.getElementById("nomeSocial").value.trim(),
    cpf: document.getElementById("cpf").value.trim(),
    rg: document.getElementById("rg").value.trim(),
    telefone: document.getElementById("telefone").value.trim()
  };
  dadosGlobais = dados;

  try {
    const res = await fetch("Contrato.pdf");
    if (!res.ok) throw new Error("Contrato.pdf não encontrado");
    const existingPdfBytes = await res.arrayBuffer();
    const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
    const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);

    const pages = pdfDoc.getPages();
    const firstPage = pages[0];
    const { height } = firstPage.getSize();

    // Preenche campos no PDF
    firstPage.drawText(dados.nome, { x:130, y:height-248, size:12, font });
    if(dados.nomeSocial) firstPage.drawText(dados.nomeSocial, { x:180, y:height-268, size:12, font });
    firstPage.drawText(dados.cpf, { x:360, y:height-270, size:12, font });
    firstPage.drawText(dados.rg, { x:120, y:height-293, size:12, font });
    firstPage.drawText(dados.telefone, { x:380, y:height-293, size:12, font });
    firstPage.drawText(`Assinado digitalmente por: ${dados.nome}`, { x:50, y:100, size:12, font });
    firstPage.drawText(`Data: ${new Date().toLocaleDateString("pt-BR")}`, { x:50, y:85, size:12, font });

    // Caso tenha mais de 1 página
    if(pages.length > 1){
      const secondPage = pages[1];
      const { height: h2 } = secondPage.getSize();
      secondPage.drawText(dados.nome, { x:250, y:h2-320, size:12, font });
      secondPage.drawText(new Date().toLocaleDateString("pt-BR"), { x:230, y:h2-300, size:12, font });
      secondPage.drawText(`Assinado digitalmente por: ${dados.nome}`, { x:50, y:100, size:12, font });
      secondPage.drawText(`Data: ${new Date().toLocaleDateString("pt-BR")}`, { x:50, y:85, size:12, font });
    }

    const pdfBytes = await pdfDoc.save();
    pdfBlobGlobal = new Blob([pdfBytes], { type:"application/pdf" });
    const localUrl = URL.createObjectURL(pdfBlobGlobal);
    pdfViewer.src = localUrl;

    // === Nome do arquivo com hash ===
    const hash = gerarHash4();
    const nomeArquivo = `${hash}_${dados.nome.replace(/\s+/g, "_")}_Contrato.pdf`;

    // Converter para base64 e enviar ao GitHub
    const base64 = await blobParaBase64(pdfBlobGlobal);
    await enviarContratoParaGitHub(nomeArquivo, base64);

    // Download automático
    const downloadLink = document.createElement('a');
    downloadLink.href = localUrl;
    downloadLink.download = nomeArquivo;
    downloadLink.click();

    // Enviar pelo WhatsApp
    const msg = encodeURIComponent(`Olá Giovana, segue o contrato assinado por ${dados.nome}`);
    window.open(`https://wa.me/${contato}?text=${msg}`, "_blank");

    alert("✅ Contrato assinado, salvo, enviado ao GitHub e baixado com sucesso!");

  } catch (err) {
    alert("Erro: " + err.message);
    console.error(err);
  } finally {
    btn.disabled = false;
    btn.textContent = originalText;
  }
});

// Converter Blob → Base64
function blobParaBase64(blob) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result.split(",")[1]);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}

// Enviar para o GitHub
async function enviarContratoParaGitHub(nomeArquivo, conteudoBase64) {
  const repo = "psigiovana/contratos-assinados";
  const token = "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"; 
  const url = `https://api.github.com/repos/${repo}/contents/contratos/${nomeArquivo}`;

  const resposta = await fetch(url, {
    method: "PUT",
    headers: {
      "Authorization": `token ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: `Adicionando contrato assinado: ${nomeArquivo}`,
      content: conteudoBase64
    })
  });

  if (!resposta.ok) {
    const erro = await resposta.json();
    console.error(erro);
    throw new Error("Falha ao enviar para o GitHub.");
  }

  const resultado = await resposta.json();
  console.log("Upload concluído:", resultado);
}
</script>
</body>
</html>
